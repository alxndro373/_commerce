{% extends "base.html" %}
{% block content %}
<div class="mb-3">
    <a href="{{ url_for('listar_productos') }}" class="btn btn-outline-secondary">Volver a Productos</a>
</div>

<div class="row">
    <div class="col-md-6">
        <img src="{{ producto.imagen_url if producto.imagen_url else '' + producto.nombre[:15]|urlencode }}" 
             class="img-fluid rounded shadow product-image-large" alt="{{ producto.nombre }}"
             >
    </div>
    <div class="col-md-6">
        <h2>{{ producto.nombre }}</h2>
        <p class="lead">{{ producto.descripcion }}</p>
        
        <!-- Información de calificaciones -->
        {% if estadisticas_reseñas.total > 0 %}
        <div class="mb-3">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    {% set estrellas_llenas = (estadisticas_reseñas.promedio)|round %}
                    {% for i in range(1, 6) %}
                        {% if i <= estrellas_llenas %}
                            <i class="bi bi-star-fill text-warning"></i>
                        {% else %}
                            <i class="bi bi-star text-muted"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="text-muted">
                    {{ "%.1f"|format(estadisticas_reseñas.promedio) }}/5.0 ({{ estadisticas_reseñas.total }} reseña{{ 's' if estadisticas_reseñas.total != 1 else '' }})
                </span>
            </div>
        </div>
        {% endif %}
        
        <div class="mb-3">
            <span class="price display-6">${{ "%.2f"|format(producto.precio) }}</span>
        </div>
        
        <div class="mb-3">
            <span class="badge {% if producto.inventario > 5 %}bg-success{% elif producto.inventario > 0 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                {% if producto.inventario > 0 %}
                    Stock disponible: {{ producto.inventario }} unidades
                {% else %}
                    Sin stock
                {% endif %}
            </span>
        </div>
        
        {% if session.get('user_id') %}
        <form action="{{ url_for('agregar_al_carrito', producto_id=producto.id) }}" method="POST">
            <input type="hidden" name="producto_id" value="{{ producto.id }}">
            <div class="row mb-3">
                <div class="col-auto">
                    <label for="cantidad" class="form-label">Cantidad:</label>
                </div>
                <div class="col-auto">
                    <input type="number" name="cantidad" id="cantidad" class="form-control" 
                           value="1" min="1" max="{{ producto.inventario }}" style="width: 80px;">
                </div>
            </div>
            <button type="submit" class="btn btn-success btn-lg" {% if producto.inventario == 0 %}disabled{% endif %}>
                {% if producto.inventario == 0 %}
                    Sin Stock
                {% else %}
                    Agregar al Carrito
                {% endif %}
            </button>
        </form>
        {% else %}
        <div class="alert alert-info">
            <p><a href="{{ url_for('login') }}" class="alert-link">Inicia sesión</a> para agregar productos al carrito.</p>
            <a href="{{ url_for('login') }}" class="btn btn-primary">Iniciar Sesión</a>
        </div>
        {% endif %}
    </div>
</div>

<hr class="my-5">

<!-- Sección de Reseñas -->
<div class="row">
    <div class="col-12">
        <h3>Reseñas del Producto</h3>
        
        <!-- Formulario para agregar reseña -->
        {% if session.get('user_id') and puede_reseñar and not ya_reseñó %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Escribir una Reseña</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('crear_reseña_producto', producto_id=producto.id) }}" method="POST">
                    <div class="mb-3">
                        <label for="calificacion" class="form-label">Calificación *</label>
                        <div class="rating-input">
                            <input type="hidden" name="calificacion" id="calificacion" value="5" required>
                            <div class="star-rating animated-stars">
                                <input type="radio" id="star5" name="rating" value="5" checked>
                                <label for="star5" class="bi bi-star-fill"></label>
                                <input type="radio" id="star4" name="rating" value="4">
                                <label for="star4" class="bi bi-star-fill"></label>
                                <input type="radio" id="star3" name="rating" value="3">
                                <label for="star3" class="bi bi-star-fill"></label>
                                <input type="radio" id="star2" name="rating" value="2">
                                <label for="star2" class="bi bi-star-fill"></label>
                                <input type="radio" id="star1" name="rating" value="1">
                                <label for="star1" class="bi bi-star-fill"></label>
                            </div>
                            <small class="text-muted">Haz clic en las estrellas para calificar</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="comentario" class="form-label">Comentario *</label>
                        <textarea class="form-control" id="comentario" name="comentario" rows="4" 
                                  placeholder="Escribe tu experiencia con este producto..." 
                                  minlength="10" maxlength="500" required></textarea>
                        <small class="text-muted">Mínimo 10 caracteres, máximo 500.</small>
                    </div>
                    
                    <button type="submit" class="btn btn-success">Publicar Reseña</button>
                </form>
            </div>
        </div>
        {% elif session.get('user_id') and ya_reseñó %}
        <div class="alert alert-info">
            Ya has escrito una reseña para este producto.
        </div>
        {% elif session.get('user_id') and not puede_reseñar %}
        <div class="alert alert-warning">
            Solo puedes escribir reseñas de productos que hayas comprado.
        </div>
        {% elif not session.get('user_id') %}
        <div class="alert alert-info">
            <a href="{{ url_for('login') }}">Inicia sesión</a> para escribir una reseña.
        </div>
        {% endif %}
        
        <!-- Lista de Reseñas -->
        {% if reseñas %}
            <div class="reseñas-lista">
                {% for reseña in reseñas %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="card-title mb-1">{{ reseña.usuario_nombre or 'Usuario Anónimo' }}</h6>
                                <div class="mb-2">
                                    {% for i in range(1, 6) %}
                                        {% if i <= reseña.calificacion %}
                                            <i class="bi bi-star-fill text-warning"></i>
                                        {% else %}
                                            <i class="bi bi-star text-muted"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="text-muted ms-2">{{ reseña.calificacion }}/5</span>
                                </div>
                            </div>
                            <small class="text-muted">
                                {{ reseña.fecha.strftime('%d/%m/%Y') if reseña.fecha else 'Fecha no disponible' }}
                            </small>
                        </div>
                        <p class="card-text">{{ reseña.comentario }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center text-muted py-4">
                <p>Este producto aún no tiene reseñas.</p>
                {% if session.get('user_id') and puede_reseñar and not ya_reseñó %}
                <p>¡Sé el primero en escribir una!</p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<style>
.star-rating {
    direction: rtl;
    display: inline-block;
    cursor: pointer;
}

.star-rating input {
    display: none;
}

.star-rating label {
    color: #ddd;
    font-size: 24px;
    padding: 0 2px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.star-rating label:hover,
.star-rating label:hover~label,
.star-rating input:checked~label {
    color: #ffc107;
}

.rating-input {
    margin-bottom: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ratingInputs = document.querySelectorAll('.star-rating input[type="radio"]');
    const calificacionHidden = document.getElementById('calificacion');
    
    // Inicializar con 5 estrellas seleccionadas
    if (calificacionHidden) {
        calificacionHidden.value = 5;
    }
    
    // Agregar listeners a los radio buttons
    ratingInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (calificacionHidden) {
                calificacionHidden.value = this.value;
            }
        });
    });
    
    // Efecto de animación al hacer clic
    document.querySelectorAll('.star-rating:not(.readonly) label').forEach(star => {
        star.addEventListener('click', function() {
            this.style.transform = 'scale(1.2)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 200);
        });
    });
});
</script>
{% endblock %}