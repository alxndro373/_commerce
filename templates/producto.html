{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-md-6">
        <img src="https://via.placeholder.com/500x400.png?text={{ producto.nombre|urlencode }}" class="img-fluid rounded" alt="{{ producto.nombre }}">
    </div>
    <div class="col-md-6">
        <h2>{{ producto.nombre }}</h2>
        <p class="lead">{{ producto.descripcion }}</p>
        
        <!-- Información de calificaciones -->
        {% if estadisticas_reseñas.total > 0 %}
        <div class="mb-3">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    {% set estrellas_llenas = (estadisticas_reseñas.promedio)|round %}
                    {% for i in range(1, 6) %}
                        {% if i <= estrellas_llenas %}
                            <span class="text-warning">⭐</span>
                        {% else %}
                            <span class="text-muted">☆</span>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="text-muted">
                    {{ estadisticas_reseñas.promedio }}/5.0 ({{ estadisticas_reseñas.total }} reseña{{ 's' if estadisticas_reseñas.total != 1 else '' }})
                </span>
            </div>
        </div>
        {% endif %}
        
        <h3 class="my-3">${{ "%.2f"|format(producto.precio) }}</h3>
        <h4>Stock: {{ producto.inventario }}</h4>
        
        {% if session.get('user_id') %}
        <form action="{{ url_for('agregar_al_carrito', producto_id=producto.id) }}" method="POST">
            <input type="hidden" name="producto_id" value="{{ producto.id }}">
            <div class="input-group mb-3" style="max-width: 150px;">
                <input type="number" name="cantidad" class="form-control" value="1" min="1" max="{{ producto.inventario }}">
            </div>
            <button type="submit" class="btn btn-primary btn-lg" {% if producto.inventario == 0 %}disabled{% endif %}>
                {% if producto.inventario == 0 %}
                    Sin Stock
                {% else %}
                    Agregar al Carrito
                {% endif %}
            </button>
        </form>
        {% else %}
        <div class="alert alert-info">
            <a href="{{ url_for('login') }}">Inicia sesión</a> para agregar productos al carrito.
        </div>
        {% endif %}
    </div>
</div>

<hr class="my-5">

<!-- Sección de Reseñas -->
<div class="row">
    <div class="col-12">
        <h3>Reseñas del Producto</h3>
        
        <!-- Formulario para agregar reseña -->
        {% if session.get('user_id') and puede_reseñar and not ya_reseñó %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Escribir una Reseña</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('crear_reseña_producto', producto_id=producto.id) }}" method="POST">
                    <div class="mb-3">
                        <label for="calificacion" class="form-label">Calificación *</label>
                        <div class="rating-input">
                            <input type="hidden" name="calificacion" id="calificacion" value="5" required>
                            <div class="stars" id="star-rating">
                                <span class="star" data-rating="1">⭐</span>
                                <span class="star" data-rating="2">⭐</span>
                                <span class="star" data-rating="3">⭐</span>
                                <span class="star" data-rating="4">⭐</span>
                                <span class="star" data-rating="5">⭐</span>
                            </div>
                            <small class="text-muted">Haz clic en las estrellas para calificar</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="comentario" class="form-label">Comentario *</label>
                        <textarea class="form-control" id="comentario" name="comentario" rows="4" 
                                  placeholder="Escribe tu experiencia con este producto..." 
                                  minlength="10" maxlength="500" required></textarea>
                        <small class="text-muted">Mínimo 10 caracteres, máximo 500.</small>
                    </div>
                    
                    <button type="submit" class="btn btn-success">Publicar Reseña</button>
                </form>
            </div>
        </div>
        {% elif session.get('user_id') and ya_reseñó %}
        <div class="alert alert-info">
            Ya has escrito una reseña para este producto.
        </div>
        {% elif session.get('user_id') and not puede_reseñar %}
        <div class="alert alert-warning">
            Solo puedes escribir reseñas de productos que hayas comprado.
        </div>
        {% elif not session.get('user_id') %}
        <div class="alert alert-info">
            <a href="{{ url_for('login') }}">Inicia sesión</a> para escribir una reseña.
        </div>
        {% endif %}
        
        <!-- Lista de Reseñas -->
        {% if reseñas %}
            <div class="reseñas-lista">
                {% for reseña in reseñas %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="card-title mb-1">{{ reseña.usuario_nombre or 'Usuario Anónimo' }}</h6>
                                <div class="mb-2">
                                    {% for i in range(1, 6) %}
                                        {% if i <= reseña.calificacion %}
                                            <span class="text-warning">⭐</span>
                                        {% else %}
                                            <span class="text-muted">☆</span>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="text-muted ms-2">{{ reseña.calificacion }}/5</span>
                                </div>
                            </div>
                            <small class="text-muted">
                                {{ reseña.fecha.strftime('%d/%m/%Y') if reseña.fecha else 'Fecha no disponible' }}
                            </small>
                        </div>
                        <p class="card-text">{{ reseña.comentario }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center text-muted py-4">
                <p>Este producto aún no tiene reseñas.</p>
                {% if session.get('user_id') and puede_reseñar and not ya_reseñó %}
                <p>¡Sé el primero en escribir una!</p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<style>
.rating-input .stars {
    font-size: 1.5rem;
    cursor: pointer;
}

.rating-input .star {
    transition: color 0.2s;
    cursor: pointer;
}

.rating-input .star:hover,
.rating-input .star.active {
    filter: brightness(1.2);
}

.rating-input .star.inactive {
    filter: grayscale(100%);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.star');
    const calificacionInput = document.getElementById('calificacion');
    
    if (stars.length > 0 && calificacionInput) {
        // Inicializar con 5 estrellas
        updateStars(5);
        
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.rating);
                calificacionInput.value = rating;
                updateStars(rating);
            });
            
            star.addEventListener('mouseover', function() {
                const rating = parseInt(this.dataset.rating);
                updateStars(rating);
            });
        });
        
        document.getElementById('star-rating').addEventListener('mouseleave', function() {
            const currentRating = parseInt(calificacionInput.value);
            updateStars(currentRating);
        });
    }
    
    function updateStars(rating) {
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
                star.classList.remove('inactive');
            } else {
                star.classList.remove('active');
                star.classList.add('inactive');
            }
        });
    }
});
</script>
{% endblock %}